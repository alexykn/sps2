# sps2

A modern, atomic package manager for macOS ARM64 with rollback capabilities and hermetic builds.

## Early Development Notice

**This project is in the early stages of development.** It is not yet recommended for production use. The API, package format, and internal architecture are still subject to change. There is no public package repository yet.

### Current Status

- ✅ **Working**: `install`, `uninstall`, `rollback`, `history`, `list`, `vulndb update`, `check-health`
- 🚧 **In Progress**: `draft` and `build` (functional but incomplete)
- ⚠️ **Untested**: `update`, `upgrade`, `info`, `search`, `reposync`, `cleanup`, `audit`, `self-update`

## Features

- 🔄 **Atomic Updates** - All package operations are atomic with instant rollback
- 📦 **Content-Addressed Storage** - Deduplication via BLAKE3 hashing
- 🏗️ **Hermetic Builds** - Reproducible builds in isolated environments
- 🔐 **Security First** - Minisign signatures, SBOM generation, CVE scanning
- 🚀 **Fast & Parallel** - Concurrent downloads and installations
- 🎯 **Single Prefix** - Clean design with everything in `/opt/pm/live/`
- 🐍 **Python-Style Versions** - Familiar version constraints (`>=1.2.0,<2.0.0`)
- 📝 **Starlark Recipes** - Simple, sandboxed build scripts

## Installation

### Prerequisites

- macOS with Apple Silicon (M1/M2/M3)
- Rust 1.86.0 or later
- SQLite 3.x
- sudo access for `/opt/pm` directory

### Build from Source

```bash
# Clone the repository
git clone https://github.com/yourusername/sps2.git
cd sps2

# Build the project
cargo build --release

# Run setup script (requires sudo)
sudo ./setup.sh

# Add to PATH in your shell config
echo 'export PATH="/opt/pm/live/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# Verify installation
sps2 --version
```

## Quick Start

### Installing Packages

```bash
# Install from repository (when available)
sps2 install jq

# Install specific version
sps2 install "jq==1.7"

# Install with version constraints
sps2 install "curl>=8.0.0,<9.0.0"

# Install from local .sp file
sps2 install ./package-1.0.0-1.arm64.sp

# Install after building (use install() in recipe)
sps2 build my-package.star  # If recipe has install() at the end
```

### Generating Build Recipes

Use the `draft` command to automatically generate recipes:

```bash
# From a Git repository
sps2 draft -g "https://github.com/BurntSushi/ripgrep"

# From a source archive URL
sps2 draft -u "https://example.com/package-1.0.tar.gz"

# From a local directory
sps2 draft -p ./my-project

# From a local archive
sps2 draft -a ./my-archive.tar.gz

# Specify output file
sps2 draft -g "https://github.com/helix-editor/helix" -o helix.star
```

### Building Packages

Example recipe for ripgrep (generated by `draft`):

```python
def metadata():
    """Package metadata"""
    return {
        "name": "ripgrep",
        "version": "14.1.1",
        "description": """ripgrep is a line-oriented search tool that recursively searches the current
                        directory for a regex pattern while respecting gitignore rules. ripgrep has
                        first class support on Windows, macOS and Linux.""",
        "license": "MIT",
        "homepage": "https://github.com/BurntSushi/ripgrep"
    }

def build(ctx):
    # Clean up any leftover files from previous builds
    cleanup(ctx)

    # Clone git repository
    git(ctx, "https://github.com/BurntSushi/ripgrep", "HEAD")

    # Allow network access for dependency downloads
    allow_network(ctx, True)

    # Build using cargo build system
    cargo(ctx, ["--release"])
```

Build with various options:

```bash
# Basic build
sps2 build ripgrep.star

# Build with custom output directory
sps2 build ripgrep.star -o ./packages/

# Build with maximum compression
sps2 build ripgrep.star --max

# Build with custom job count
sps2 build ripgrep.star -j 8
```

### Managing Packages

```bash
# List installed packages
sps2 list

# Example output:
# ┌─────────┬─────────┬───────────┬─────────────┐
# │ Package ┆ Version ┆ Status    ┆ Description │
# ╞═════════╪═════════╪═══════════╪═════════════╡
# │ bat     ┆ 0.25.0  ┆ Installed ┆ -           │
# ├╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┤
# │ helix   ┆ 25.1.1  ┆ Installed ┆ -           │
# ├╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┤
# │ ripgrep ┆ 14.1.1  ┆ Installed ┆ -           │
# └─────────┴─────────┴───────────┴─────────────┘

# Show package info
sps2 info jq

# Search for packages
sps2 search rust

# Update packages (respects version constraints)
sps2 update

# Upgrade to latest versions
sps2 upgrade curl

# Uninstall packages
sps2 uninstall jq
```

### State Management

```bash
# View state history
sps2 history

# Example output:
# ┌────────────────────────┬─────────┬───────────┬──────────────────┬──────────┐
# │ State ID               ┆ Current ┆ Operation ┆ Created          ┆ Packages │
# ╞════════════════════════╪═════════╪═══════════╪══════════════════╪══════════╡
# │ 48b6f85f-78bb-4dc5-... ┆ *       ┆ install   ┆ 2025-06-13 16:12 ┆ 4        │
# ├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌┤
# │ a7be49ca-a976-4f75-... ┆         ┆ install   ┆ 2025-06-13 16:11 ┆ 3        │
# └────────────────────────┴─────────┴───────────┴──────────────────┴──────────┘

# Rollback to previous state
sps2 rollback

# Rollback to specific state
sps2 rollback 48b6f85f-78bb-4dc5-9487-a8a60e97423b

# Clean up orphaned packages and old states
sps2 cleanup

# Check system health
sps2 check-health
```

### Security Features

```bash
# Update vulnerability database
sps2 vulndb update

# Show vulnerability database statistics
sps2 vulndb stats

# Audit installed packages for vulnerabilities
sps2 audit

# Audit specific package
sps2 audit --package curl

# Fail on critical vulnerabilities
sps2 audit --fail-on-critical
```

### Repository Management

```bash
# Sync repository index
sps2 reposync

# Update sps2 itself
sps2 self-update
```

## How It Works

sps2 uses an innovative atomic update system:

1. **Content-Addressed Store** - All package files are stored by their BLAKE3 hash
2. **State Directories** - Each system state is a complete filesystem tree
3. **Atomic Swaps** - Updates use APFS clones and atomic renames
4. **Instant Rollback** - Previous states are preserved and can be restored instantly

### Directory Structure

```
/opt/pm/
├── live/          # Current active state (add /opt/pm/live/bin to PATH)
├── store/         # Content-addressed package storage
├── states/        # Historical states for rollback
└── state.sqlite   # Package database
```

## Building Your Own Packages

sps2 uses Starlark (Python-like) scripts for package recipes. See the [Starlark API Documentation](STARLARK_API_DOCUMENTATION.md) for the complete reference.

### Example: Rust Application (Helix Editor)

```starlark
def metadata():
    """Package metadata"""
    return {
        "name": "helix",
        "version": "25.1.1",
        "description": """A post-modern modal text editor.""",
        "license": "MPL2"
    }

def build(ctx):
    # Clean up any leftover files from previous builds
    cleanup(ctx)

    # Clone git repository
    git(ctx, "https://github.com/helix-editor/helix", "HEAD")

    # Allow network access for dependency downloads
    allow_network(ctx, True)

    # Build using cargo build system
    cargo(ctx, ["--release"])
```

### Example: Meson Project (pkgconf)

```starlark
def metadata():
    """Package metadata"""
    return {
        "name": "pkgconf",
        "version": "2.4.3",
        "description": """A system for managing library compile/link flags""",
        "license": "CUSTOM"
    }

def build(ctx):
    # Clean up any leftover files from previous builds
    cleanup(ctx)

    # Clone git repository
    git(ctx, "https://github.com/pkgconf/pkgconf", "HEAD")

    # Build using meson build system
    meson(ctx, ["--buildtype=release"])
```

### Example: Building from Source Archive

```starlark
def metadata():
    return {
        "name": "curl",
        "version": "8.5.0",
        "description": "Command line tool for transferring data",
        "homepage": "https://curl.se",
        "license": "CUSTOM",
        "depends": ["openssl>=3.0.0", "zlib~=1.2.11"],
        "build_depends": ["pkg-config>=0.29", "autoconf>=2.71"]
    }

def build(ctx):
    # Fetch source archive
    fetch(ctx, "https://curl.se/download/curl-8.5.0.tar.gz")

    # Configure with autotools
    configure(ctx, [
        "--prefix=" + ctx.PREFIX,
        "--with-openssl",
        "--with-zlib"
    ])

    # Build and install
    make(ctx, ["-j" + str(ctx.JOBS)])
    make(ctx, ["install", "DESTDIR=stage"])
```

## Contributing

We welcome contributions! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.


## Documentation

- [Architecture Overview](ARCHITECTURE.md) - Detailed system design
- [Starlark API Reference](STARLARK_API_DOCUMENTATION.md) - Build script documentation
- [Contributing Guide](CONTRIBUTING.md) - How to contribute
- [Code of Conduct](CODE_OF_CONDUCT.md) - Community guidelines

## Security

- Packages are signed with [Minisign](https://jedisct1.github.io/minisign/) // TODO
- All downloads are verified against BLAKE3 hashes [BLAKE3](https://github.com/BLAKE3-team/BLAKE3)
- SBOM (Software Bill of Materials) generated for every package
- Offline CVE scanning via integrated vulnerability database

## License

BSD 3-Clause License. See [LICENSE.md](LICENSE.md) for details.

## Acknowledgments

sps2 stands on the shoulders of giants:

- [moss & boulder](https://github.com/AerynOS/os-tools) AerynOS - atomic updates, content-addressed storage, stateful package management
- [Homebrew](https://brew.sh/) - Inspiration for macOS-native packaging
- [Starlark](https://github.com/bazelbuild/starlark) - For the build recipe language

---

*Building the future of package management on macOS, one atomic update at a time.*
